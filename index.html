<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Siatka odwiedzonych kwadratów</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      top: 12px; left: 12px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      padding: 10px 12px;
      font: 14px/1.3 system-ui, sans-serif;
    }
    .panel label { display: flex; align-items: center; gap: 8px; margin: 6px 0; cursor: pointer; }
    .btn {
      display: inline-block;
      border: none;
      border-radius: 10px;
      padding: 8px 10px;
      background: #1f6feb;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(31,111,235,0.35);
    }
    .legend {
      position: absolute;
      bottom: 12px; left: 12px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 8px 10px;
      font: 12px/1.3 system-ui, sans-serif;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .chip { display:inline-block; padding:2px 6px; border-radius: 8px; margin-right:6px; border:1px solid #ddd; }
    .chip.big { background:#f0f6ff; border-color:#3a71ff; }
    .chip.small { background:#f0fff6; border-color:#37c46a; }
    .counter { margin-top:8px; font-size:13px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div style="font-weight:600; margin-bottom:6px;">Warstwy siatki</div>
    <label><input id="toggleBig" type="checkbox" checked /> Siatka duża (zoom 14)</label>
    <label><input id="toggleSmall" type="checkbox" checked /> Siatka mała (zoom 17)</label>
    <hr style="border:none; border-top:1px solid #e9e9e9; margin:8px 0;">
    <button id="locateBtn" class="btn">Śledź moją lokalizację</button>
    <div class="counter" id="counter"></div>
  </div>

  <div class="legend">
    <div><span class="chip big"></span> duże kwadraty – kafelki zoom 14 (odwiedzone = wypełnione na niebiesko)</div>
    <div><span class="chip small"></span> małe kwadraty – kafelki zoom 17 (odwiedzone = wypełnione na zielono)</div>
  </div>

  <script>
    const map = L.map('map').setView([52.2297, 21.0122], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }).addTo(map);

    const bigGridLayer = L.layerGroup().addTo(map);
    const smallGridLayer = L.layerGroup().addTo(map);

    const bigStyle = { color: '#1f6feb', weight: 2.5, opacity: 0.9, fillOpacity: 0 };
    const smallStyle = { color: '#37c46a', weight: 0.8, opacity: 0.8, fillOpacity: 0 };

    // Ładowanie odwiedzonych z localStorage
    const visitedBig = new Set(JSON.parse(localStorage.getItem('visitedBig') || "[]"));
    const visitedSmall = new Set(JSON.parse(localStorage.getItem('visitedSmall') || "[]"));

    function saveVisited() {
      localStorage.setItem('visitedBig', JSON.stringify([...visitedBig]));
      localStorage.setItem('visitedSmall', JSON.stringify([...visitedSmall]));
    }

    function drawGrid(zRef, layer, style, visitedSet, fillColor) {
      layer.clearLayers();
      const bounds = map.getBounds();
      const nw = map.project(bounds.getNorthWest(), zRef);
      const se = map.project(bounds.getSouthEast(), zRef);
      const tileSize = 256;
      const startX = Math.floor(nw.x / tileSize) * tileSize;
      const startY = Math.floor(nw.y / tileSize) * tileSize;
      const endX   = Math.ceil(se.x / tileSize) * tileSize;
      const endY   = Math.ceil(se.y / tileSize) * tileSize;

      let total = 0, visitedCount = 0;

      for (let x = startX; x < endX; x += tileSize) {
        for (let y = startY; y < endY; y += tileSize) {
          total++;
          const id = `${zRef}-${x}-${y}`;
          const pNW = L.point(x, y);
          const pSE = L.point(x + tileSize, y + tileSize);
          const llNW = map.unproject(pNW, zRef);
          const llSE = map.unproject(pSE, zRef);

          const rect = L.rectangle([llNW, llSE], {
            ...style,
            fillColor: visitedSet.has(id) ? fillColor : undefined,
            fillOpacity: visitedSet.has(id) ? 0.3 : 0
          });

          if (visitedSet.has(id)) visitedCount++;

          layer.addLayer(rect);
        }
      }
      return { total, visitedCount };
    }

    function scheduleRedraw() {
      requestAnimationFrame(() => {
        const bigStats = drawGrid(14, bigGridLayer, bigStyle, visitedBig, '#1f6feb');
        const smallStats = drawGrid(17, smallGridLayer, smallStyle, visitedSmall, '#37c46a');

        document.getElementById("counter").textContent =
          `Duże: ${bigStats.visitedCount}/${bigStats.total}  |  Małe: ${smallStats.visitedCount}/${smallStats.total}`;
      });
    }

    scheduleRedraw();
    map.on('moveend zoomend resize', scheduleRedraw);

    document.getElementById('toggleBig').addEventListener('change', e => {
      e.target.checked ? bigGridLayer.addTo(map) : map.removeLayer(bigGridLayer);
    });
    document.getElementById('toggleSmall').addEventListener('change', e => {
      e.target.checked ? smallGridLayer.addTo(map) : map.removeLayer(smallGridLayer);
    });

    function getTileIdForLatLng(latlng, zRef) {
      const p = map.project(latlng, zRef);
      const tileSize = 256;
      const x = Math.floor(p.x / tileSize) * tileSize;
      const y = Math.floor(p.y / tileSize) * tileSize;
      return `${zRef}-${x}-${y}`;
    }

    let watchActive = false;
    let userMarker, userCircle;

    document.getElementById('locateBtn').addEventListener('click', () => {
      if (watchActive) {
        map.stopLocate();
        watchActive = false;
        alert("Śledzenie zatrzymane.");
        return;
      }
      if (!navigator.geolocation) return alert('Brak wsparcia geolokalizacji.');
      map.locate({ setView: true, watch: true, maxZoom: 17, enableHighAccuracy: true });
      watchActive = true;
      alert("Rozpoczęto śledzenie pozycji.");
    });

    map.on('locationfound', e => {
      const { latlng, accuracy } = e;
      if (userMarker) map.removeLayer(userMarker);
      if (userCircle) map.removeLayer(userCircle);
      userMarker = L.marker(latlng).addTo(map);
      userCircle = L.circle(latlng, { radius: accuracy, color: '#1f6feb', weight: 1 }).addTo(map);

      // oznaczamy odwiedzone kwadraty
      const bigId = getTileIdForLatLng(latlng, 14);
      const smallId = getTileIdForLatLng(latlng, 17);

      let changed = false;
      if (!visitedBig.has(bigId)) { visitedBig.add(bigId); changed = true; }
      if (!visitedSmall.has(smallId)) { visitedSmall.add(smallId); changed = true; }

      if (changed) {
        saveVisited();
        scheduleRedraw();
      }
    });

    map.on('locationerror', e => alert('Błąd geolokalizacji: ' + e.message));
  </script>
</body>
</html>
